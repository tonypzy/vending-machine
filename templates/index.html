<!DOCTYPE html>
<html>
<head>
    <title>Vend-nier</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
    font-family: 'Roboto', sans-serif;
    background-color: #f8f9fa;
    margin: 0;
    padding: 2rem;
    box-sizing: border-box;

    /* Red checkerboard background */
    background-image: 
        linear-gradient(45deg, #ff6f61 25%, transparent 25%), 
        linear-gradient(-45deg, #ff6f61 25%, transparent 25%), 
        linear-gradient(45deg, transparent 75%, #ff6f61 75%), 
        linear-gradient(-45deg, transparent 75%, #ff6f61 75%);
    background-size: 80px 80px;
    background-position: 0 0, 0 20px, 20px -20px, -20px 0px;
}

body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    padding: 2rem;
    box-sizing: border-box;

    /* Vending machine-inspired smooth red gradient background */
    background-color: #b71c1c; /* rich vending-machine red base */
    background-image: 
        radial-gradient(circle at 20% 20%, #ff3a3a 0%, transparent 50%),
        radial-gradient(circle at 80% 30%, #ff5252 0%, transparent 50%),
        radial-gradient(circle at 50% 70%, #e53935 0%, transparent 50%),
        radial-gradient(circle at 30% 80%, #d32f2f 0%, transparent 50%);
    background-blend-mode: overlay;
}






.header {
    text-align: center;
    margin: 0; /* remove auto margin */
    padding: 0.5rem 0; /* vertical padding only */
    border-radius: 0; /* optional: remove rounded corners for full-width look */
    background-color: #fff; /* header box color */
    width: 100%; /* full width */
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    border-bottom: 3px solid #b71c1c; /* optional: keep bottom border for style */
    position: relative;
}

.header h1 {
    font-size: 2.5rem;
    margin: 0;
    font-family: 'Courier New', monospace;
    color: #b71c1c;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

.header p {
    font-size: 1rem;
    margin-top: 0.5rem;
    font-style: italic;
    color: #800000;
}

.container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    /* Remove the gap so the map and form appear connected */
    gap: 0; 
    width: 100%;
    max-width: 1200px; /* optional: constrain width */
    margin: 2rem auto;
}

.form-container, .map-container {
    background-color: #fff;
    padding: 2rem;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}

#map {
    border-radius: 12px;
}

/* Make form-container on left, map-container on right */
.form-container {
    flex: 1 1 400px; /* grow/shrink, minimum width */
    
}

.map-container {
    flex: 2 1 500px; /* map is wider */
    min-width: 400px;
}

/* Optional: remove internal spacing between the boxes */
.container > * {
    margin: 0;
}


        select[multiple] {
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        #results-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 6px;
            box-shadow: inset 0 -6px 6px -6px rgba(0,0,0,0.1);
        }

        .result-card {
    background-color: #fafafa;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
}

.result-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
}

.pill {
    background-color: #e9ecef;
    color: #495057;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    margin: 2px 4px 2px 0;
    display: inline-block;
}



        .map-container {
            flex: 2;
            min-width: 400px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group h4 {
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 0.8rem;
            color: #555;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        input[type="checkbox"], input[type="radio"] {
            margin-right: 8px;
            accent-color: #8B0000;
        }

        button {
            background-color: #8B0000;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            margin-top: 1rem;
        }

        button:hover {
            background-color: #A52A2A;
        }

        button:active {
            transform: scale(0.98);
        }

        #search-results {
            margin-top: 2rem;
        }

        #search-results h3 {
            border-bottom: 2px solid #ddd;
            padding-bottom: 0.5rem;
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .result-card {
            background-color: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
            cursor: pointer;
        }

        .result-card:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .result-card h4 {
            margin: 0 0 0.5rem 0;
            color: #8B0000;
        }

        .result-card .muted {
            font-size: 0.8rem;
            color: #777;
        }

        .pill-container {
            margin-top: 0.5rem;
        }

        .pill {
            display: inline-block;
            background-color: #e9ecef;
            color: #495057;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-right: 6px;
            margin-bottom: 6px;
        }
        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 1rem;
            border-radius: 6px;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8B0000;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none; /* Hide by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            color: #8B0000;
            margin-left: 10px;
            font-style: italic;
            display: none; /* Hide by default */
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-bar"></div> <!-- Checkerboard top bar -->
        <h1>Vend-nier</h1>
        <p>Find vending machines "nier" you</p>
    </div>

    <div class="container" style="display: flex; gap: 2rem; flex-wrap: wrap;">

    <!-- LEFT SIDE: Form + Search Results -->
    <div style="flex:1 1 400px; display: flex; flex-direction: column; gap: 1rem; background-color: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08);">

        <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
            <!-- Payment Methods + Services -->
            <div style="flex:1; min-width:200px;">
                <div class="form-group">
                    <h4>Payment Methods</h4>
                    <div class="checkbox-group">
                        {% for method in ['Visa','Apple Pay','Discover','MasterCard','Google Pay','American Express','Cash','BuckID'] %}
                            <label><input type="checkbox" name="choices" value="{{ method }}" {% if method in selected_choices %}checked{% endif %}> {{ method }}</label>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <h4>Services</h4>
                    <div class="checkbox-group">
                        {% for service in ['Drinks','Snacks'] %}
                            <label><input type="checkbox" name="services" value="{{ service }}" {% if service in selected_services %}checked{% endif %}> {{ service }}</label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Providers + Special Access -->
            <div style="flex:1; min-width:200px;">
                <div class="form-group">
                    <h4>Providers</h4>
                    <div class="checkbox-group">
                        {% for provider in ['Coca Cola','DASANI','Vitamin Water','Various'] %}
                            <label><input type="checkbox" name="providers" value="{{ provider }}" {% if provider in selected_providers %}checked{% endif %}> {{ provider }}</label>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <h4>Special Access?</h4>
                    <div class="checkbox-group">
                        <label><input type="radio" name="special_access" value="Yes" onclick="toggleBuildings()" {% if special_access=='Yes' %}checked{% endif %}> Yes</label>
                        <label><input type="radio" name="special_access" value="No" onclick="toggleBuildings()" {% if special_access=='No' %}checked{% endif %}> No</label>
                    </div>
                </div>

                <div id="building_group" class="form-group" style="display:none;">
                    <h4>Select Buildings</h4>
                    <select name="buildings" id="buildings-select" multiple size="8" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ccc;">
                        {% for building in ['Baker Systems Engineering','Barrett House','Blackburn House','Bradley Hall','Denny Hall','Houck House','Jones Tower','Lincoln Tower','Mack Hall','Mendoza House','Morrill Tower','Morrison Tower','Neil Building','Norton House','Nosker House','Park-Stradley Hall','Paterson Hall','Smith-Steeb Hall','Taylor Tower','Worthington Building'] %}
                            <option value="{{ building }}" {% if building in selected_buildings %}selected{% endif %}>{{ building }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Search Button -->
        <form id="search-form">
            <button type="submit" style="margin-top: 1rem;">Search</button>
        </form>

        <!-- Search Results spanning full left side -->
        </div>

    <!-- RIGHT COLUMN: Map -->
    <div class="map-container" style="flex:2 1 500px; min-width:400px; display:flex; flex-direction:column; height:400px;">
        <div id="map" style="flex:1; width:100%;"></div>
    </div>

    <!-- SEARCH RESULTS (spanning full width below both columns) -->
    <div id="search-results" style="flex-basis:100%; margin-top:1rem; background:white; padding:1rem; border-radius:6px;">
        <h3>Search Results</h3>
        <div id="results-list" style="max-height:400px; overflow-y:auto;">Click Search to load results...</div>
    
</div>

    
    <script>
        // ======== NEW: Global variables for map state ========
        let map;
        let userMarker;
        let routeLine;
        let vendingMarkersLayer; // A layer to hold all vending machine markers
        let userLocation = null; // To store user's coordinates

        function toggleBuildings() {
            const yesRadio = document.querySelector('input[name="special_access"][value="Yes"]');
            document.getElementById("building_group").style.display = yesRadio && yesRadio.checked ? "block" : "none";
        }

        // ======== NEW: Function to pan the map to a marker ========
        function panToMarker(lat, lon, openPopup) {
            if (!map) return;
            map.setView([lat, lon], 17); // Zoom in closer
            // Bonus: find the marker and open its popup
            vendingMarkersLayer.eachLayer(function(layer) {
                if (layer.getLatLng().lat == lat && layer.getLatLng().lng == lon) {
                     if(openPopup) layer.openPopup();
                }
            });
        }

        // ======== NEW: Function to fetch a route to a SPECIFIC destination ========
        async function fetchRouteTo(endLat, endLon) {
            if (!userLocation) {
                alert("Your location is not available yet. Please wait.");
                return;
            }

            const startLon = userLocation.longitude;
            const startLat = userLocation.latitude;

            const res = await fetch("/route", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ start: [startLon, startLat], end: [endLon, endLat] })
            });
            const data = await res.json();

            if (data.coordinates) {
                // Remove old route line if it exists
                if (routeLine) {
                    map.removeLayer(routeLine);
                }
                const latlngs = data.coordinates.map(c => [c[1], c[0]]);
                routeLine = L.polyline(latlngs, { color: '#8B0000', weight: 5, opacity: 0.7 }).addTo(map);

                // Fit map to the route bounds
                map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
            }
        }

        window.onload = function() {
            toggleBuildings();

            const defaultLat = {{ latitude }};
            const defaultLon = {{ longitude }};

            map = L.map('map').setView([defaultLat, defaultLon], 14);
            vendingMarkersLayer = L.featureGroup().addTo(map);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        userLocation = pos.coords; // Store user location
                        if (userMarker) map.removeLayer(userMarker);
                        userMarker = L.marker([userLocation.latitude, userLocation.longitude]).addTo(map)
                            .bindPopup("<b>You are here</b>").openPopup();
                        map.setView([userLocation.latitude, userLocation.longitude], 15);
                        runSearchAndShow(); // Run search after getting location
                    },
                    () => {
                        // On failure, use default and run search
                        userLocation = { latitude: defaultLat, longitude: defaultLon };
                        if (userMarker) map.removeLayer(userMarker);
                        userMarker = L.marker([defaultLat, defaultLon]).addTo(map)
                            .bindPopup("<b>Your approximate location</b>");
                        runSearchAndShow();
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                // Geolocation not supported
                userLocation = { latitude: defaultLat, longitude: defaultLon };
                runSearchAndShow();
            }

            // search parameters from the form
            function buildSearchQuery() {
                const p = new URLSearchParams();
                const pm = Array.from(document.querySelectorAll('input[name="choices"]:checked')).map(i => i.value.toLowerCase());
                if (pm.length) p.set('payment_methods', pm.join(','));
                const svcs = Array.from(document.querySelectorAll('input[name="services"]:checked')).map(i => i.value.toLowerCase());
                if (svcs.length) p.set('services', svcs.join(','));
                const prov = Array.from(document.querySelectorAll('input[name="providers"]:checked')).map(i => i.value.toLowerCase());
                if (prov.length) p.set('provider', prov.join(','));
                const sa = document.querySelector('input[name="special_access"]:checked');
                if (sa) p.set('special_access', sa.value === 'Yes' ? 'true' : 'false');
                p.set('from', '0');
                p.set('size', '200'); // Get more results for the map
                return p.toString();
            }

            // ======== MODIFIED: This function now also updates the map markers ========
            function renderMapMarkers(list) {
                // Clear all previous vending machine markers
                vendingMarkersLayer.clearLayers();

                if (!list || list.length === 0) return;

                list.forEach(item => {
                    if (item.location && item.location.lat && item.location.lon) {
                        const lat = item.location.lat;
                        const lon = item.location.lon;

                        // Create a popup with a "Get Directions" button
                        const popupContent = `
                            <b>${item.store_name || 'Unknown'}</b><br>
                            ${item.address || ''}<br>
                            <button onclick="fetchRouteTo(${lat}, ${lon})">Get Directions</button>
                        `;

                        const marker = L.marker([lat, lon])
                            .bindPopup(popupContent);

                        // Add the new marker to our dedicated layer
                        marker.addTo(vendingMarkersLayer);
                    }
                });

                // Adjust map to show all markers, if any were added
                if (vendingMarkersLayer.getLayers().length > 0) {
                    map.fitBounds(vendingMarkersLayer.getBounds(), { padding: [50, 50] });
                }
            }

            // render the page
            function renderResults(list, total) {
              const container = document.getElementById('results-list');
              if (!container) return;
              if (!list || list.length === 0) {
                container.innerHTML = '<div class="muted">No results found.</div>';
                return;
              }
              const html = `
                <div class="muted" style="margin-bottom:6px;">Total: ${total}</div>
                ${list.map(item => {
                  // ======== MODIFIED: Added onclick to pan the map ========
                  const lat = item.location ? item.location.lat : null;
                  const lon = item.location ? item.location.lon : null;

                  const services = Array.isArray(item.services) ? item.services : [];
                  const payments = Array.isArray(item.payment_methods) ? item.payment_methods : [];
                  const pillsS = services.map(s => `<span class="pill">${s}</span>`).join(' ');
                  const pillsP = payments.map(s => `<span class="pill">${s}</span>`).join(' ');

                  return `
                    <div class="result-card" onclick="panToMarker(${lat}, ${lon}, true)">
                      <h4>${item.store_name || 'Unknown'} <span class="muted">#${item.machine_id}</span></h4>
                      <div class="muted">${item.address || ''} • ${item.campus || ''}</div>
                      <div class="pill-container">
                          ${pillsS} ${pillsP}
                      </div>
                    </div>
                  `;
                }).join('')}
              `;
              container.innerHTML = html;
            }

            // get the backend api
            async function runSearchAndShow() {
              const formEl = document.getElementById('search-form');
              const searchBtn = formEl.querySelector('button');
              const resultsList = document.getElementById('results-list');
              searchBtn.disabled = true;
              resultsList.innerHTML = `<div class="loading-spinner"></div><div class="loading-text">Searching...</div>`;
              
              const qs  = buildSearchQuery();
              const url = '/api/machines/search' + (qs ? ('?' + qs) : '');
              try {
                const resp = await fetch(url);
                const data = await resp.json();
                if (!resp.ok || !data.ok) {
                  resultsList.innerHTML = `<div class="error-message">Search failed: ${data.error || 'Unknown error'}</div>`;
                  return;
                }
                renderResults(data.results, data.total);
                renderMapMarkers(data.results);
              } catch (e) {
                resultsList.innerHTML = `<div class="error-message">Search error: ${e}</div>`;
              } finally {
                searchBtn.disabled = false;
              }
            }

            const formEl = document.getElementById('search-form');
            if (formEl) {
              formEl.addEventListener('submit', function (e) {
                e.preventDefault();
                runSearchAndShow();
              });
            }

            // Initial search is now triggered after geolocation is determined.
        };
    </script>
</body>
</html>